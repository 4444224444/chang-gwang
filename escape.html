<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>escape</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #container {
      width: 100vw;
      height: 100vh;
      background: black;
    }

    #cluePopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      z-index: 2000;
    }

    #clueInventory {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60vw;
      height: 60vh;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid white;
      padding: 1rem;
      overflow: auto;
      z-index: 3000;
      color: white;
    }

    #clueInventory h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    #clueImages {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    #clueImages img {
      width: 150px;
      border: 1px solid white;
    }

    #clueInventory button {
      position: absolute;
      top: 10px;
      right: 20px;
      background: white;
      color: black;
      font-weight: bold;
      border: none;
      padding: 0.3rem 1rem;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <audio id="bgm" src="assets/audio/bgm.mp3" autoplay loop></audio>
  <div id="container"></div>

  <!-- ë‹¨ì„œ ì´ë¯¸ì§€ íŒì—… -->
  <img id="cluePopup" />

  <!-- ë‹¨ì„œ ì¸ë²¤í† ë¦¬ -->
  <div id="clueInventory">
    <h2>ðŸ“œ ì£¼ìš´ ë‹¨ì„œë“¤</h2>
    <div id="clueImages"></div>
    <button onclick="document.getElementById('clueInventory').style.display='none'">ë‹«ê¸°</button>
  </div>

  <!-- Three.js & Panolens -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.105.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/panolens@0.12.0/build/panolens.min.js"></script>

  <script>
    let hasKey = false;

    const clues = {
      clue1: false,
      clue2: false,
      clue3: false,
      clue4: false
    };

    const panorama = new PANOLENS.ImagePanorama('assets/images/roomre.png');
    const viewer = new PANOLENS.Viewer({
      container: document.querySelector("#container"),
      autoRotate: true,
      autoRotateSpeed: 0.3
    });
    viewer.add(panorama);

    function showCluePopup(clueKey) {
      const popup = document.getElementById('cluePopup');
      popup.src = `assets/images/${clueKey}.png`;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 2000);
    }

    function createVisibleInfospot(x, y, z, clueKey) {
      const spot = new PANOLENS.Infospot(80); // í¬ê²Œ!
      spot.position.set(x, y, z);
      spot.addHoverText("ë‹¨ì„œ ë°œê²¬");

      spot.addEventListener('click', () => {
        if (!clues[clueKey]) {
          clues[clueKey] = true;
          showCluePopup(clueKey);
        }
      });

      panorama.add(spot);
    }

    // ë‹¨ì„œë“¤ ìƒì„±
    createVisibleInfospot(3000, -500, -2000, "clue1");
    createVisibleInfospot(-2500, 0, -1500, "clue2");
    createVisibleInfospot(500, -1000, 2000, "clue3");
    createVisibleInfospot(0, -2000, 1000, "clue4");

    // ë¬¸ (ì •ë‹µ ìž…ë ¥)
    const doorSpot = new PANOLENS.Infospot(80);
    doorSpot.position.set(0, -500, -3000);
    doorSpot.addHoverText("ë¬¸");

    doorSpot.addEventListener('click', () => {
      const allFound = Object.values(clues).every(v => v);
      if (!allFound) {
        alert("ì•„ì§ ëª¨ë“  ë‹¨ì„œë¥¼ ëª¨ìœ¼ì§€ ëª»í–ˆì–´ìš”.");
        return;
      }

      const input = prompt("ë„¤ê°€ ë³¸ ë„¤ ì¢…ì´ì˜ ìˆ«ìžë¥¼ ë§í•˜ë¼. (ì˜ˆ: 7194)");
      if (input === "7194") {
        alert("ë‹¹ì‹ ì€ ì§„ì‹¤ì„ ë³´ì•˜ìŠµë‹ˆë‹¤. íƒˆì¶œí•©ë‹ˆë‹¤.");
        hasKey = true;
        // location.href = "ending.html";
      } else {
        alert("ê·¸ ìˆœì„œëŠ” ì§„ì‹¤ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }
    });
    panorama.add(doorSpot);

    // Tabí‚¤: ë‹¨ì„œ ì¸ë²¤í† ë¦¬ ì—´ê¸°, ESC: ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const modal = document.getElementById('clueInventory');
        const container = document.getElementById('clueImages');
        container.innerHTML = '';

        for (let i = 1; i <= 4; i++) {
          const key = `clue${i}`;
          if (clues[key]) {
            const img = document.createElement('img');
            img.src = `assets/images/${key}.png`;
            container.appendChild(img);
          }
        }

        modal.style.display = 'block';
      }

      if (e.key === 'Escape') {
        document.getElementById('clueInventory').style.display = 'none';
      }
    });

    window.onload = function () {
  const name = localStorage.getItem("userName");
  const started = localStorage.getItem("hasStarted");
  const justEntered = localStorage.getItem("justEnteredStage3");

  if (!name || started !== "true") {
    location.href = "index.html"; // í•„ìˆ˜ ì •ë³´ ì—†ìœ¼ë©´ ë‹¤ì‹œ index
    return;
  }

  // ì²˜ìŒ ë“¤ì–´ì˜¨ ê±°ë©´ í”Œëž˜ê·¸ë§Œ ì§€ì›€ (ë©”ì‹œì§€ ì•ˆ ë„ì›€)
  if (justEntered === "true") {
    localStorage.removeItem("justEnteredStage3");
  } else {
    // ë‘ ë²ˆì§¸ ì´ìƒ ì§„ìž… ì‹œ ë©”ì‹œì§€ ì¶œë ¥
    alert(`${name}ë‹˜, ì–´ë”” ê°€ì„¸ìš”? ë„ë§ì¹˜ëŠ” ê±´ê°€ìš”?`);
  }
};


window.onload = function () {
  const name = localStorage.getItem("userName");
  const started = localStorage.getItem("hasStarted");
  const justEntered = localStorage.getItem("justEnteredStage3");

  if (!name || started !== "true") {
    location.href = "index.html";
    return;
  }

  if (justEntered === "true") {
    localStorage.removeItem("justEnteredStage3");
  } else {
    alert(`${name}ë‹˜, ì–´ë”” ê°€ì„¸ìš”...? ë„ë§ì¹˜ëŠ” ê±´ê°€ìš”?`);
  }
};




  </script>
</body>
</html>




<!--
ì°¸ê³ í•œ ê°•ì¢Œ:
https://youtu.be/k90zdEgWgcw?si=SZ2J3VRyDK87YBd9
ê°•ì¢Œ ë³´ê³  í•˜ì˜€ëŠ”ë° ì›í•˜ëŠ” ëŠë‚Œì´ëž‘ ì¡°ê¸ˆ ë‹¬ëžì–´ì„œ ê·¸ ë¶€ë¶„ì€ ì±—ì§€í”¼í‹° ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤
-->